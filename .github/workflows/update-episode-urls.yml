name: Update Episode URLs

on:
  workflow_dispatch:
    inputs:
      guid:
        description: "Episode GUID (leave empty to update all episodes)"
        required: false
        type: string
      update_spotify:
        description: "Update Spotify URLs"
        required: false
        default: true
        type: boolean
      update_youtube:
        description: "Update YouTube URLs"
        required: false
        default: true
        type: boolean
      update_apple:
        description: "Update Apple Podcast URLs"
        required: false
        default: false
        type: boolean
      update_amazon:
        description: "Update Amazon Music URLs"
        required: false
        default: false
        type: boolean

jobs:
  update-episode-urls:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Update Episode URLs
        env:
          SPOTIFY_CLIENT_ID: ${{ secrets.SPOTIFY_CLIENT_ID }}
          SPOTIFY_CLIENT_SECRET: ${{ secrets.SPOTIFY_CLIENT_SECRET }}
          YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
        run: |
          PLATFORMS_UPDATED=()

          # Update Spotify URLs
          if [ "${{ inputs.update_spotify }}" = "true" ]; then
            echo "📝 Updating Spotify URLs..."
            if [ -n "${{ inputs.guid }}" ]; then
              echo "   Updating specific episode: ${{ inputs.guid }}"
              npm run update-spotify-urls "${{ inputs.guid }}"
            else
              echo "   Updating all episodes without Spotify URLs"
              npm run update-spotify-urls
            fi
            PLATFORMS_UPDATED+=("Spotify")
          fi

          # Update YouTube URLs
          if [ "${{ inputs.update_youtube }}" = "true" ]; then
            echo ""
            echo "📝 Updating YouTube URLs..."
            if [ -n "${{ inputs.guid }}" ]; then
              echo "   Updating specific episode: ${{ inputs.guid }}"
              npm run update-youtube-urls "${{ inputs.guid }}"
            else
              echo "   Updating all episodes without YouTube URLs"
              npm run update-youtube-urls
            fi
            PLATFORMS_UPDATED+=("YouTube")
          fi

          # Update Apple Podcast URLs
          if [ "${{ inputs.update_apple }}" = "true" ]; then
            echo ""
            echo "⚠️  Apple Podcast URL updates are not yet supported"
            echo "   Coming soon!"
          fi

          # Update Amazon Music URLs
          if [ "${{ inputs.update_amazon }}" = "true" ]; then
            echo ""
            echo "⚠️  Amazon Music URL updates are not yet supported"
            echo "   Coming soon!"
          fi

          # Save updated platforms for PR title
          if [ ${#PLATFORMS_UPDATED[@]} -eq 0 ]; then
            echo "No platforms were updated"
          else
            PLATFORMS_LIST=$(IFS=", "; echo "${PLATFORMS_UPDATED[*]}")
            echo "PLATFORMS_UPDATED=$PLATFORMS_LIST" >> $GITHUB_ENV
          fi

      - name: Check for changes
        id: check_changes
        run: |
          if git diff --quiet; then
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected"
          else
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected"
          fi

      - name: Create Pull Request
        if: steps.check_changes.outputs.changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update episode URLs (${{ env.PLATFORMS_UPDATED }})"
          title: "🔗 Update Episode URLs (${{ env.PLATFORMS_UPDATED }})"
          body: |
            ## 🔗 Automated Episode URL Update

            This PR was automatically generated by the GitHub Action workflow.

            ### Changes
            - Platforms: **${{ env.PLATFORMS_UPDATED }}**
            - Updated `episodes.json` with URLs for episodes that were missing them
            ${{ inputs.guid && format('- Episode GUID: **{0}**', inputs.guid) || '- Updated all episodes missing URLs' }}

            ### Platform Selection
            - Spotify: ${{ inputs.update_spotify && '✅' || '❌' }}
            - YouTube: ${{ inputs.update_youtube && '✅' || '❌' }}
            - Apple Podcast: ${{ inputs.update_apple && '✅' || '❌' }}
            - Amazon Music: ${{ inputs.update_amazon && '✅' || '❌' }}

            ### Details
            - Workflow run: [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - Triggered by: ${{ github.event_name }}

            Please review the changes and merge if everything looks good! 🚀
          branch: automated/update-episode-urls
          delete-branch: true
          labels: |
            automated
            episode-urls
            enhancement

      - name: Summary
        if: steps.check_changes.outputs.changes == 'true'
        run: |
          echo "✅ Pull request created successfully!"
          echo "Check the 'Pull Requests' tab to review and merge the changes."
