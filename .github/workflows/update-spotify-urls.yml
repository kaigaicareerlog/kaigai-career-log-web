name: Update Episode URLs

on:
  workflow_dispatch:
    inputs:
      guid:
        description: "Episode GUID (leave empty to update all episodes)"
        required: false
        type: string
      platform:
        description: "Platform to update (spotify, youtube, apple, amazon, all)"
        required: false
        default: "spotify"
        type: choice
        options:
          - spotify
          - youtube
          - apple
          - amazon
          - all

jobs:
  update-episode-urls:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Update Episode URLs
        env:
          SPOTIFY_CLIENT_ID: ${{ secrets.SPOTIFY_CLIENT_ID }}
          SPOTIFY_CLIENT_SECRET: ${{ secrets.SPOTIFY_CLIENT_SECRET }}
        run: |
          PLATFORM="${{ inputs.platform }}"
          if [ "$PLATFORM" = "spotify" ] || [ "$PLATFORM" = "all" ]; then
            echo "📝 Updating Spotify URLs..."
            if [ -n "${{ inputs.guid }}" ]; then
              echo "   Updating specific episode: ${{ inputs.guid }}"
              npm run update-spotify-urls "${{ inputs.guid }}"
            else
              echo "   Updating all episodes without Spotify URLs"
              npm run update-spotify-urls
            fi
          else
            echo "⚠️  Platform '$PLATFORM' is not yet supported"
            echo "   Currently only 'spotify' is supported"
            echo "   Coming soon: youtube, apple, amazon"
          fi

      - name: Check for changes
        id: check_changes
        run: |
          if git diff --quiet; then
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected"
          else
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected"
          fi

      - name: Create Pull Request
        if: steps.check_changes.outputs.changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update episode URLs (${{ inputs.platform }})"
          title: "🔗 Update Episode URLs (${{ inputs.platform }})"
          body: |
            ## 🔗 Automated Episode URL Update

            This PR was automatically generated by the GitHub Action workflow.

            ### Changes
            - Platform: **${{ inputs.platform }}**
            - Updated `episodes.json` with URLs for episodes that were missing them
            ${{ inputs.guid && format('- Episode GUID: **{0}**', inputs.guid) || '- Updated all episodes missing URLs' }}

            ### Details
            - Workflow run: [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - Triggered by: ${{ github.event_name }}

            Please review the changes and merge if everything looks good! 🚀
          branch: automated/update-episode-urls
          delete-branch: true
          labels: |
            automated
            episode-urls
            enhancement

      - name: Summary
        if: steps.check_changes.outputs.changes == 'true'
        run: |
          echo "✅ Pull request created successfully!"
          echo "Check the 'Pull Requests' tab to review and merge the changes."
